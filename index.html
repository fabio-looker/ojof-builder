
<html>
<head>
	<title>Outer Join on False | LookML Builder</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json-editor/0.7.28/jsoneditor.min.js" integrity="sha256-51+oMmpgSgS4jV5/DcGKnDHIOL6Jeie2i7ka6sPQVro=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" integrity="sha256-NTds7atVCDeolLUzbcl45lx4gJYO+hNXCaX1wC2HQHc=" crossorigin="anonymous" />
<style>textarea{font-size:10pt !important;}</style>
<script>
	// Set the JSONEditor CSS theme and icon library globally
	JSONEditor.defaults.theme = 'foundation5';
	JSONEditor.defaults.iconlib = 'fontawesome4';
</script>
</head>
<body>
<!--<div id="panel-toggle" style="height:2em;width:2em;position:fixed;left:-1px;bottom:-1px;z-index:20;text-align:center;background-color:#DDD;color:#333;border:1px solid #666;cursor:pointer;">
	<i class="fa fa-eye-slash"></i>
</div>-->
<h1>Outer Join on False | LookML Builder</h2>
<div>
	<div id="build-panel" style="max-width:1200px;margin:0 auto">
		<form id="build-form">
			<div id="json-editor"></div>
			<div id="msg" style="white-space:pre-line;color:#333;background-color:#DDB"></div>
			<div style="text-align:right">
				<div  style="display:inline-block;vertical-align:top;margin: 0 2em;">
					<input type="submit" style="margin-left:auto;margin-right:auto;border:solid 1px black" value="Go" class="button" />
				</div>
			</div>
		</form>
	</div>
	<div style="max-width:640px;margin:0 auto">
		<h2>Tips</h2>
		<ul style="font-size:0.8em; font-family:serif; color:#333;">
			<li> This is a static HTML file and can be used locally. If you are running it from a shared domain, other scripts on that domain may have access to data you enter here.</li>
		</ul>
	</div>
	<div style="width:100%">
		<h2>Built Model</h2>
		<textarea style="width:100%;height:32em" readonly="readonly" id="text-out"></textarea>
	</div>
</div>
</body>
<script>
var storageKey="json-outerjoinonfalse"
var inputSchema={
		type:"object",
		title:"LookML Builder Form",
		options:{"disable_edit_json":false,"disable_properties":false,"remove_empty_properties":true,"display_required_only":true},
		properties:{
				"connectionName":{
						title:"Name of your connection",
						type:"string"
					},
				"dialect":{
						title:"SQL Dialect",
						type:"string",
						enum:["BigQuery Standard","Redshift"]
					},
				"exploreName":{
					title:"Explore name",
					type:"string"//,
					//required:false
				},
				"views":{
						title:"Views",
						type:"array",
						format:"tabs",
						items:{
								type:"object",
								title:"View",
								headerTemplate:"{{self.name}}",
								options:{disable_collapse:true},
								properties:{
										"name":{title:"Name",type:"string"},
										"keys":{
												type:"object",
												format:"compact",
												title:"Keys",
												properties:{
														primary:{title:"Primary key",type:"string"},
														distribution:{title:"Dist key (RS only)",type:"string"},
														sort:{title:"Sort key (RS only)",type:"string"}
													}
											},
										"dimensions":{
												type:"array",
												format:"tabs",
												title:"Dimensions",
												items:{
														type:"object",
														title:"Dimension",
														headerTemplate:"{{self.name}}",
														options:{disable_collapse:true},
														properties:{
																name:{title:"Name",type:"string"},
																sql:{title:"sql",type:"string"},
																rest:{title:"Other LookML",type:"string",format:"textarea"}
															}
													}
											},
										"measures":{
												type:"array",
												format:"tabs",
												title:"Measures",
												items:{
														type:"object",
														title:"Measure",
														headerTemplate:"{{self.name}}",
														options:{disable_collapse:true},	
														properties:{
																name:{title:"Name",type:"string"},
																type:{title:"Built-in type",type:"string",enum:[
																		"Count","Sum","Average","Listagg",""
																	]},
																sql:{title:"sql",type:"string"},
																rest:{title:"Other LookML",type:"string",format:"textarea"}
															}
													}
											},
										"otherLookml":{title:"Other LookML", type:"string", format:"textarea"}
									}
							}
					},
				"normalizedRelationships":{
						title:"Normalized relationships",
						type:"array",
						format:"table",
						items:{
								type:"object",
								title:"Relationship",
								headerTemplate:"{{self.baseTable}} -> {{self.dimensionTable}}",
								options:{disable_collapse:true},
								properties:{
										baseTable:{type:"string",title:"Many table"},
									 	foreignKey:{type:"string",title:"Many.FK"},
										foreignKey:{type:"string",title:"One Table"},
									}
							}
					},
				"conformedRelationships":{
						title:"Conformed relationships",
						type:"array",
						items:{
								type:"object",
								title:"Relationship",
								headerTemplate:"{{self.name}}",
								options:{disable_collapse:true},
								properties:{
									name:{type:"string",title:"Name"},
									type:{type:"string",title:"Type",enum:["Date","Other"]}
									//timeframes
									//conformedColumns:{type:"array"}
								}
							}
					}	
			}
	}

var initialValue={}

function buildFunction(input,templates){
		return templates.main(input)
	}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.0/doT.min.js" integrity="sha256-0DJpUBhIByZ5Tm5u/xEvcRalEiuyadItx381FmBKHB4=" crossorigin="anonymous"></script>
<script>
/*Defaults
doT.templateSettings = {
  evaluate:    /\{\{([\s\S]+?)\}\}/g,
  interpolate: /\{\{=([\s\S]+?)\}\}/g,
  encode:      /\{\{!([\s\S]+?)\}\}/g,
  use:         /\{\{#([\s\S]+?)\}\}/g,
  define:      /\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,
  conditional: /\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,
  iterate:     /\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,
  varname: 'it',
  strip: true,
  append: true,
  selfcontained: false
};
*/
doT.templateSettings.varname="x";
doT.templateSettings.strip=false;

function lookmlName(s){
		return s.replace(/[^a-zA-Z0-9_]+/g,"").toLowerCase()
	}
	
</script>
<script type="template" id="main">
connection: "{{=x.connectionName}}"
explore: {{= lookmlName(x.exploreName) ||  "all_the_things"}} {
  hidden: yes
  
  # "Base"/"Measure" joins
  {{~ x.views.filter(v=>v.measures.length) :view:v }}
  join: accounts {
    type: full_outer
    relationship: one_to_one
    fields: [
      {{= view.keys.primary}}
      {{~view.measures :measure}}
        , {{= measure.name}}
      {{~}} #Todo: Add timeframes
    ]

    {{?  x.dialect=="BigQuery Standard"}}
    sql_on: FALSE ;;
    {{?? x.dialect=="Redshift Standard"}}
    #Redshift (Only allows FOJ on merge joins, which require dist & sort key equality)
    sql_on: 
	  {{= view.name}}.{{= view.key.dist}} = {{x.exploreName}}.base AND {{= view.name}}.{{= view.key.sort}} = {{x.exploreName}}.base 
	  {{~ x.views.filter.filter((prior,p)=>prior.measures.length && p<v) :prior:p}} 
	    {% if {{= prior.name}}.{{= prior.key.primary}}._in_query
		{{~ prior.measures :measure}}or {{= prior.name}}.{{= measure.name}}._in_query{{~}}
		%}
		AND {{= view.name}}.{{= view.key.dist}} = {{= prior.name}}.{{= prior.key.dist}} AND {{= view.name}}.{{= view.key.sort}} = {{= prior.name}}.{{= prior.key.sort}}
	  	{% endif %}
	  {{~}}
	  ;;
    {{?}}
  }
  {{~}}

  #"Dimension table" joins
  
  join: associated_product {
    view_label: "Products"
    fields: [name]
    type: full_outer
    relationship: many_to_one
    from: products
    # This pattern is required when there are multiple levels of
    # normalization, e.g. orders -> products -> accounts.
    # Why? Looker doesn't automatically join in associated_products
    # if a user selects something from both accounts and orders/pageviews,
    # but not from products.
    # So: I am always requiring this join if accounts is required, but it
    # changes between products or an empty select as appropriate based on
    # wheter dependent fields are in the query
    # ...Also, liquid's boolean is basic... https://github.com/Shopify/liquid/issues/138
    sql_table_name:
    {%
      if associated_product.name._in_query
      or orders.count._in_query
      or orders.total_sales._in_query
      or pageviews.count._in_query
      or all_the_things.product_conversion_rate._in_query
      or products.count_subtotal_by_account._in_query
      %}products{%
      else
      %}
    (SELECT null as id, null as account_id FROM (SELECT NULL x) p where x IS NOT NULL)
    {% endif %};;
    sql_on: ${associated_product.id}=COALESCE({%
      if products.count._in_query
      or products.count_subtotal._in_query
      or products.name._in_query
      or products.count_subtotal_by_account._in_query
      %}
      products.id, {% endif %}{%
      if pageviews.count._in_query
      or all_the_things.product_conversion_rate._in_query
      %}
      pageviews.product_id, {% endif %}{%
      if orders.count._in_query
      or orders.total_sales._in_query
      or all_the_things.product_conversion_rate._in_query
      %}
      orders.product_id, {% endif %}
      NULL) ;;
  }
  join: associated_account {
    view_label: "Accounts"
    from: accounts
    fields: [id,employees,name]
    type: full_outer
    relationship: many_to_one
    sql_on: ${associated_account.id}=COALESCE({%
      if accounts.count._in_query
      or accounts.employees._in_query
      or accounts.name._in_query
      or accounts.total_employees._in_query
      or products.count_subtotal_by_account._in_query
      %}
      accounts.id, {% endif %}{%
      if products.count._in_query
      or products.count_subtotal._in_query
      %}
      products.account_id, {% endif %}{%
      if managers.count._in_query
      %}
      managers.account_id, {% endif %}{%
      if pageviews.count._in_query
      or orders.count._in_query
      or orders.total_sales.in_query
      or associated_product.name._in_query
      or all_the_things.product_conversion_rate._in_query
      or products.count_subtotal_by_account._in_query
      %}
      ${associated_product.account_id}, {% endif %}
      NULL);;
  }
}


view: {{= x.exploreName}} {
  view_label: "[All the things]"
  #BQ: sql_table_name: (SELECT base FROM (SELECT null as base) as btable WHERE base IS NOT NULL);;
  #Redshift (Only allows FOJ on merge joins, which require dist & sort key equality)
  derived_table: {
    sql: (SELECT base FROM (SELECT null as base) as btable WHERE base IS NOT NULL) ;;
    persist_for: "1 hour"
    distribution: "base"
    sortkeys: ["base"]
  }
  dimension: base {
    hidden: yes
    sql: ${TABLE}.base ;;
  }
  dimension_group: combined {
    type: time
    timeframes: [date,week,month]
    sql: ${combined_date_internal} ;;
  }
  dimension: combined_date_internal {
    hidden: yes
    sql: COALESCE({%
      if pageviews.count._in_query
      or all_the_things.product_conversion_rate._in_query
      %}
      pageviews.pv_date, {% endif %}{%
      if orders.count._in_query
      or orders.total_sales._in_query
      or all_the_things.product_conversion_rate._in_query
      %}
      CASE {% parameter orders.combined_date_on %}
      WHEN 'Order Date' THEN orders.order_date
      WHEN 'Shipped Date' THEN orders.shipped_date
      ELSE orders.order_date
      END, {% endif %}
      CAST(NULL as timestamp)
    );;
  }
  measure: product_conversion_rate {
    type: number
    value_format_name: decimal_3
    sql: CASE WHEN ${pageviews.count}<>0 THEN ${orders.count} / ${pageviews.count} ELSE NULL END;;
  }
}


view: accounts {
  derived_table: {
    sql:
     SELECT 1 as id, 'Acme' as name, 80 as employees
     UNION ALL
     SELECT 2 as id, 'Initech' as name, 120 as employees
    ;;
    persist_for: "1 hour"
    distribution: "id"
    sortkeys: ["id"]
  }
  dimension: id {
    hidden:  yes
    type: number
    sql: ${TABLE}.id ;;
  }
  dimension: name {
    type: string
    sql: ${TABLE}.name ;;
  }
  dimension: employees {
    type: number
    sql: ${TABLE}.employees ;;
  }
  measure: total_employees {
    type: number #Keep nulls as nulls
    sql: SUM(${employees}) ;;
  }
  measure: count {
    type: number
    sql: CASE WHEN MIN(${id}) IS NULL THEN NULL ELSE COUNT(${id}) END ;;
  }
}

view: products {
  derived_table: {
    sql:
     SELECT 1 as id, 'Rockets' as name, 1 as account_id
     UNION ALL
     SELECT 2 as id, 'Portable Holes' as name, 1 as account_id
     UNION ALL
     SELECT 3 as id, 'Synergy' as name, 2 as account_id
    ;;
    persist_for: "1 hour"
    distribution: "id"
    sortkeys: ["id"]
  }
  dimension: id {
    hidden:  yes
    type: number
    sql: ${TABLE}.id ;;
  }
  dimension: account_id {
    hidden:  yes
    type: number
    sql: ${TABLE}.account_id ;;
  }
  dimension: name {
    type: string
    sql: ${TABLE}.name ;;
  }
  measure: count {
    type: number
    sql: CASE WHEN MIN(${id}) IS NULL THEN NULL ELSE COUNT(${id}) END;;
  }
  measure: count_subtotal_by_account {
    type: number
    required_fields: [accounts.id,associated_account.id]
    sql: CASE WHEN ${accounts.id} IS NOT NULL
         THEN SUM(${count}) OVER (PARTITION BY ${associated_account.id})
         ELSE NULL END
    ;;
  }
}

view: managers {
  derived_table: {
    sql:
     SELECT 1 as id, 'Wakko' as name, 1 as account_id
     UNION ALL
     SELECT 2 as id, 'Yakko' as name, 1 as account_id
     UNION ALL
     SELECT 3 as id, 'Dot' as name, 1 as account_id
     UNION ALL
     SELECT 4 as id, 'Bill' as name, 2 as account_id
    ;;
    persist_for: "1 hour"
    distribution: "id"
    sortkeys: ["id"]
  }
  dimension: id {
    hidden:  yes
    type: number
    sql: ${TABLE}.id ;;
  }
  dimension: account_id {
    hidden:  yes
    type: number
    sql: ${TABLE}.account_id ;;
  }
  dimension: name {
    type: string
    sql: ${TABLE}.name ;;
  }
  measure: count {
    type: number
    sql: CASE WHEN MIN(${id}) IS NULL THEN NULL ELSE COUNT(${id}) END;;
  }
}

view: pageviews {
  derived_table: {
    sql:
     SELECT CAST('2017-01-02' as timestamp) as pv_date, 1 as product_id
     UNION ALL
     SELECT CAST('2017-01-15' as timestamp) as pv_date, 2 as product_id
     UNION ALL
     SELECT CAST('2017-01-24' as timestamp) as pv_date, 2 as product_id
     UNION ALL
     SELECT CAST('2017-02-02' as timestamp) as pv_date, 1 as product_id
     UNION ALL
     SELECT CAST('2017-02-02' as timestamp) as pv_date, 3 as product_id
     UNION ALL
     SELECT CAST('2017-02-02' as timestamp) as pv_date, NULL as product_id
     UNION ALL
     SELECT CAST('2017-02-21' as timestamp) as pv_date, 2 as product_id
     UNION ALL
     SELECT CAST('2017-03-02' as timestamp) as pv_date, 3 as product_id
     UNION ALL
     SELECT CAST('2017-03-02' as timestamp) as pv_date, NULL as product_id
     UNION ALL
     SELECT CAST('2017-03-15' as timestamp) as pv_date, 2 as product_id
    ;;
    persist_for: "1 hour"
    distribution: "product_id"
    sortkeys: ["pv_date"]
  }
  dimension: distkey { sql:${product_id};; hidden: yes }
  dimension: sortkey { sql:${pv_date_raw};; hidden: yes }

  dimension_group: pv_date {
    hidden:  yes
    timeframes: [raw,date,week,month,year]
    type: time
    sql: ${TABLE}.pv_date ;;
  }
  dimension: product_id {
    hidden:  yes
    type: number
    sql: ${TABLE}.product_id ;;
  }
  measure: count {
    type: number
    sql: CASE WHEN MIN(${TABLE}.pv_date) IS NULL THEN NULL ELSE COUNT(${TABLE}.pv_date) END ;;
  }
}


view: orders {
  derived_table: {
    sql:
     SELECT CAST('2017-01-02' as timestamp) as order_date, CAST('2017-01-06' as timestamp) as shipped_date, 1 as product_id, 200 as sale_price
     UNION ALL
     SELECT CAST('2017-02-02' as timestamp) as order_date, CAST('2017-02-02' as timestamp) as shipped_date,  3 as product_id, 1000 as sale_price
     UNION ALL
     SELECT CAST('2017-02-21' as timestamp) as order_date, CAST('2017-03-08' as timestamp) as shipped_date, 2 as product_id, 25 as sale_price
     UNION ALL
     SELECT CAST('2017-03-15' as timestamp) as order_date, CAST('2017-04-02' as timestamp) as shipped_date, 2 as product_id, 50 as sale_price
    ;;
    persist_for: "1 hour"
    distribution: "product_id"
    sortkeys: ["order_date"]
  }
  dimension: distkey { sql:${product_id};; hidden: yes }
  dimension: sortkey { sql:${order_date_raw};; hidden: yes }

  filter: combined_date_on {
    suggestions: ["Order Date","Shipped Date"]
  }
  dimension_group: order_date {
    timeframes: [raw,date,week,month,year]
    type: time
    sql: ${TABLE}.order_date ;;
  }
  dimension_group: shipped_date {
    timeframes: [raw,date,week,month,year]
    type: time
    sql: ${TABLE}.order_date ;;
  }
  dimension: product_id {
    hidden:  yes
    type: number
    sql: ${TABLE}.product_id ;;
  }
  dimension: sale_price {
    type: number
    value_format_name: usd
    sql: ${TABLE}.sale_price ;;
  }
  measure: count {
    type: number
    sql: CASE WHEN MIN(${TABLE}.order_date) IS NULL THEN NULL ELSE COUNT(${TABLE}.order_date) END ;;
  }
  measure: total_sales {
    type: number #Not sum because we like nulls as nulls
    sql: SUM(${sale_price}) ;;
  }
}
</script>
<script>
var editorDef= {
		schema: inputSchema,
		startval: tryJSONParse(qs("o")) || tryJSONParse(localStorage.getItem(storageKey)) || initialValue,
		"required_by_default":true,
		//"disable_collapse":true,
		"disable_properties":true,
		"display_required_only":true,
		"keep_oneof_values":true,
		"disable_edit_json":true
	}
var editor = new JSONEditor($("#json-editor")[0],editorDef)
editor.on('change',function() {
		localStorage.setItem(storageKey,JSON.stringify(editor.getValue()))
		$("#msg").hide()
	});
	
var templates={}
$("script[type=template]").each(function(i,el){templates[this.id]=doT.template($(this).text())})

$("#panel-toggle").click(function(){$("#build-panel").toggle()})

$("#text-out").focus(function(){
		// Highlight all on select
		// Solution per http://stackoverflow.com/a/24589806
		$(this).on("click.a keyup.a", function(e){
				$(this).off("click.a keyup.a").select();
			});
	});



$("#build-form").on("submit",function(evt){
		evt.preventDefault();
		$("#msg").hide();
		var errs=editor.validate();
		if(errs.length){
				$("#msg")
				.text(errs.map(e=>e.path+": "+e.message).join("\n"))
				.show()
				return;
			}
		var editorValue=editor.getValue()
		$("#text-out").val(buildFunction(editorValue,templates))
	})

//Just functions below

function set(obj,path,val){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				obj[head]=val
			}else{
				obj[head]=obj[head]||{};
				set(obj[head],path.slice(1),val)
			}
		return obj;
	}
function get(obj,path){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				return obj && obj[head];
			}else{
				return get(obj[head],path.slice(1))
			}
	}

function objByOf(byKeys,ofKey){
		byKeys=(byKeys instanceof Array ? byKeys : [byKeys])
		return function(accum,x,i){
				return set(accum,byKeys.map(k=>get(x,k)),ofKey?get(x,ofKey):x)
			}
	}
function sorter(path){
		return function(a,b){
				return get(a,path)-get(b,path)
			}
	}

function nonce(len) {
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for (var i = 0; i < len; i++){
				text += possible.charAt(Math.floor(Math.random() * possible.length));
			}
		return text;
	}
function autoLabel(name){
		return name.replace(/(^|_)([a-z])/g,s=>s.toUpperCase()).replace(/_/g," ")
	}
	
function pathBuilderObjectToString(obj){
	
	
	
	
	}
function tryJSONParse(s){
		try{
				return JSON.parse(s)
			}catch(e){
				return undefined
			}
	}
function qs(k){
		return document.location.search.slice(1).split("&")
		.filter(function(p){return p.indexOf(encodeURIComponent(k)+"=")===0})
		.map(function(p){return decodeURIComponent(p.split("=").slice(1).join("="))})[0]
	}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96247573-1', 'auto');
  ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
  ga('set', 'checkStorageTask', null); // Disable cookie storage checking.
  ga('set', 'historyImportTask', null); // Disable history checking (requires reading from cookies).
  ga('send', 'pageview');

</script>
</html>
