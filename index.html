<!doctype html >
<html>
<head>
<title>LookML Builder</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" integrity="sha256-NTds7atVCDeolLUzbcl45lx4gJYO+hNXCaX1wC2HQHc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json-editor/0.7.28/jsoneditor.min.js" integrity="sha256-51+oMmpgSgS4jV5/DcGKnDHIOL6Jeie2i7ka6sPQVro=" crossorigin="anonymous"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/nunjucks/3.0.0/nunjucks.min.js" integrity="sha256-LWvp8rf/ha5W5zb5rGjypfi/b8w5Yo0Lm+W6ccH3ejA=" crossorigin="anonymous"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.0/doT.min.js" integrity="sha256-0DJpUBhIByZ5Tm5u/xEvcRalEiuyadItx381FmBKHB4=" crossorigin="anonymous"></script>

<style>
 textarea{font-size:10pt !important;}
 .out {width:100%;height:20em;}
</style>
<script>
	// Set the JSONEditor CSS theme and icon library globally
	JSONEditor.defaults.theme = 'foundation5';
	JSONEditor.defaults.iconlib = 'fontawesome4';
	$(document).ready(()=>{
			var editorDef= {
					schema: inputSchema,
					startval: tryJSONParse(qs("o")) || tryJSONParse(localStorage.getItem(storageKey)) || initialValue,
					"required_by_default":true,
					//"disable_collapse":true,
					"disable_properties":true,
					"display_required_only":true,
					"keep_oneof_values":true,
					"disable_edit_json":true
				}
			var editor = new JSONEditor($("#json-editor")[0],editorDef)
			editor.on('change',function() {
					localStorage.setItem(storageKey,JSON.stringify(editor.getValue()))
					$("#msg").hide()
				});
				
				doT.templateSettings = {
						evaluate:    /\<\<\!([\s\S]+?)\>\>/g,
						interpolate: /\<\<\:([\s\S]+?)\>\>/g,
						encode:      /\<\<&([\s\S]+?)\>\>/g,
						use:         /\<\<#([\s\S]+?)\>\>/g,
						define:      /\<\<##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\>\>/g,
						conditional: /\<\<\?(\?)?\s*([\s\S]*?)\s*\>\>/g,
						iterate:     /\<\<\*\s*(?:\>\>|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\>\>)/g,
						varname: 'x',
						strip: false,
						append: true,
						selfcontained: false
					};	
			/* NJK var env=nunjucks.configure({
					tags: {
							blockStart: '<%',
							blockEnd: '%>',
							variableStart: '<$',
							variableEnd: '$>',
							commentStart: '<#',
							commentEnd: '#>'
						}
				});*/
			var templates={}
			$("script[type='text/x-dot-template']").each(function(i,el){
					var t=this.dataset;
					//templates[t.name]=nunjucks.compile($(this).text(),env)
					templates[t.name]=doT.template($(this).text())
					$("#out").append("<h2>"+(t.label||t.name)+"</h2><textarea readonly='readonly' class='out' data-name='"+t.name+"'></textarea>")
				})

			$("#text-out").focus(function(){
					// Highlight all on select
					// Solution per http://stackoverflow.com/a/24589806
					$(this).on("click.a keyup.a", function(e){
							$(this).off("click.a keyup.a").select();
						});
				});



			$("#build-form").on("submit",function(evt){
					evt.preventDefault();
					$("#msg").hide();
					var errs=editor.validate();
					if(errs.length){
							$("#msg")
							.text(errs.map(e=>e.path+": "+e.message).join("\n"))
							.show()
							return;
						}
					var editorValue=editor.getValue()
					var input=customTransform(editorValue)
					console.log("Building", input)
					$(".out").each(function(i,el){
							try{
									//NJK $(this).val(templates[this.dataset.name].render(input))
									$(this).val(templates[this.dataset.name](input).replace(/\n\s*\n/g,"\n"))
								}catch(e){
									console.error(e)
								}
						})
				})
		})
	
	//Just functions below

	function set(obj,path,val){
			if(path.split){path=path.split('.')}
			var head=path[0];
			if(path.length==1){
					obj[head]=val
				}else{
					obj[head]=obj[head]||{};
					set(obj[head],path.slice(1),val)
				}
			return obj;
		}
	function get(obj,path){
			if(path.split){path=path.split('.')}
			var head=path[0];
			if(path.length==1){
					return obj && obj[head];
				}else{
					return get(obj[head],path.slice(1))
				}
		}
	function unique(x,i,a){return a.indexOf(x)===i}
	function not(f){return function(...argArr){return !f(...argArr)}}
	function flatten(a,b){return a.concat(b)}
	function truthy(x){return !!x}
	function objByOf(byKeys,ofKey){
			byKeys=(byKeys instanceof Array ? byKeys : [byKeys])
			return function(accum,x,i){
					return set(accum,byKeys.map(k=>get(x,k)),ofKey?get(x,ofKey):x)
				}
		}
	function sorter(path){
			return function(a,b){
					return get(a,path)-get(b,path)
				}
		}
	function tryJSONParse(s){
			try{
					return JSON.parse(s)
				}catch(e){
					return undefined
				}
		}
	function qs(k){
			return document.location.search.slice(1).split("&")
			.filter(function(p){return p.indexOf(encodeURIComponent(k)+"=")===0})
			.map(function(p){return decodeURIComponent(p.split("=").slice(1).join("="))})[0]
		}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96247573-1', 'auto');
  ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
  ga('set', 'checkStorageTask', null); // Disable cookie storage checking.
  ga('set', 'historyImportTask', null); // Disable history checking (requires reading from cookies).
  ga('send', 'pageview');

</script>
</head>
<body>
	<h1>LookML Builder</h2>
	<div>
		<div id="build-panel" style="width:80vw;min-width:640px;margin:0 auto">
			<form id="build-form">
				<div id="json-editor"></div>
				<div id="msg" style="white-space:pre-line;color:#333;background-color:#DDB"></div>
				<div style="text-align:right">
					<div  style="display:inline-block;vertical-align:top;margin: 0 2em;">
						<input type="submit" style="margin-left:auto;margin-right:auto;border:solid 1px black" value="Go" class="button" />
					</div>
				</div>
			</form>
		</div>
		<div style="max-width:640px;margin:0 auto">
			<h2>Tips</h2>
			<ul style="font-size:0.8em; font-family:serif; color:#333;">
				<li> This is a static HTML file and can be used locally. If you are running it from a shared domain, other scripts on that domain may have access to data you enter here.</li>
			</ul>
		</div>
		<div style="width:80vw;min-width:640px;margin:0 auto">
			<h2>Built Model</h2>
			<div id="out"></div>
		</div>
	</div>
</body>
<!-- Input schema-->
<script>
	var storageKey="json-outerjoinonfalse"
	var pat={
			sql:"^[^;]+(;[^;]+)*$",
			oneLineString:"^[^\"\\n]+$",
			multiLineStringPattern:"^[^\"]+$",
			atom:"^[a-zA-Z0-9_]+$",
			atomOrNone:"^[a-zA-Z0-9_]*$"
		}
	var inputSchema={
			type:"object",
			title:"LookML Builder Form",
			options:{"disable_edit_json":false,"disable_properties":false,"remove_empty_properties":true,"display_required_only":true},
			properties:{
					"connectionName":{
							title:"Name of your connection",
							type:"string",
							pattern:pat.oneLineString
						},
					"dialect":{
							title:"SQL Dialect",
							type:"string",
							enum:["BigQuery Standard","Redshift"]
						},
					"exploreName":{
						title:"Explore Label",
						type:"string",
						pattern:pat.oneLineString
					},
					"views":{
							title:"Views",
							type:"array",
							format:"tabs",
							items:{
									type:"object",
									title:"View",
									headerTemplate:"{{self.label}} ({{self.table}})",
									options:{disable_collapse:true},
									properties:{
											"label":{title:"Label",type:"string", pattern:pat.oneLineString},
											"table":{title:"Table",type:"string", pattern:pat.atom},
											/*"viewId":{
												options:{hidden:true},
												type:"string",
												watch:{i1:"i1"},
												template:"{{i1}}"
											},*/
											"pk":{
													type:"object",
													title:"Primary Key",
													properties:{
															sql:{title:"SQL",type:"string", pattern:pat.atom},
															/*modes:{
																	type:"object",
																	title:"Show",
																	format:"compact",
																	properties:{*/
																			dim:{type:"boolean",format:"checkbox",title:"Dimension"},
																			count:{type:"boolean",format:"checkbox",title:"Count"}
																		/*}
																}*/
														}
												},
											"rs":{
													type:"object",
													format:"compact",
													title:"[Redshift only]",
													properties:{
															dist:{title:"Dist key",type:"string", pattern:pat.atomOrNone},
															sort:{title:"Sort key",type:"string", pattern:pat.atomOrNone}
														}
												},
											"fields":{
													type:"array",
													format:"tabs",
													title:"Fields",
													items:{
															type:"object",
															title:"Field",
															headerTemplate:"{{self.label}}",
															options:{disable_collapse:true},
															properties:{
																	label:{title:"Label",type:"string", pattern:pat.oneLineString},
																	sql:{title:"SQL",type:"string", pattern:pat.sql},
																	/*modes:{
																			type:"object",
																			title:"Modes",
																			format:"compact",
																			properties:{*/
																					dim:{type:"boolean",format:"checkbox",title:"Dimension"},
																					sum:{type:"boolean",format:"checkbox",title:"Sum"},
																					avg:{type:"boolean",format:"checkbox",title:"Average"},
																					min:{type:"boolean",format:"checkbox",title:"Min"},
																					max:{type:"boolean",format:"checkbox",title:"Max"},
																					list:{type:"boolean",format:"checkbox",title:"List"}
																				/*}
																		}*/,
																	"otherLookml":{title:"Other LookML", type:"string", format:"textarea"}
																}
														}
												}
										}
								}
						},
					"normalizedRelationships":{
							title:"Normalized relationships",
							type:"array",
							format:"table",
							options:{disable_array_delete_last_row:true,disable_array_delete_all_rows:true,disable_array_reorder:true},
							items:{
									type:"object",
									properties:{
											leftViewName:{
													type:"string",
													title:"\"Many\" Table",
													options:{input_width:"12em"},
													watch:{views:"views"},
													enumSource:[{
															source:"views",
															title:"{{item.label}} ({{item.table}})",
															value:"{{item.label}}_{{i}}"
														}]
												},
										 	foreignKey:{
												type:"string",
												title:"ManyTable.FK",
												options:{input_width:"28em"},
												pattern:pat.atom},
											rightViewName:{
													type:"string",
													title:"\"One\" Table",
													options:{input_width:"12em"},
													watch:{views:"views"},
													enumSource:[{
															source:"views",
															title:"{{item.label}} ({{item.table}})",
															value:"{{item.label}}_{{i}}"
														}]
												}
										}
								}
						},
					"conformedRelationships":{
							title:"Conformed relationships",
							type:"array",
							format:"tabs",
							//options:{},
							items:{
									type:"object",
									title:"Relationship",
									headerTemplate:"{{self.Label}}",
									options:{disable_collapse:true},
									properties:{
										name:{type:"string",title:"Label"},
										type:{type:"string",title:"Type",enum:["Date","Other"]}
										//timeframes
										//conformedColumns:{type:"array"}
									}
								}
						},
					"timeframes":{
							title:"Timeframes",
							type:"array",
							uniqueItems:true,
							items:{
									type:"string",
									enum:[
											"year",
											"month",
											"week",
											"day",
											"hour",
											"hour_of_day",
											"day_of_week",
											"month_of_year"
										]
								}
						}	
				}
		}

	var initialValue={}
	
	function customTransform (x){
			return Object.assign(x,{
					views:x.views.map((v,vi)=>Object.assign(v,{
							n:vi,
							name:lookmlName(v.label)+"_"+vi,
							mName:lookmlName(v.label)+"_"+vi+"m",
							dName:lookmlName(v.label)+"_"+vi+"d",
							fields:v.fields.map((f,fi)=>Object.assign(f,{
									n:fi,
									name:lookmlName(f.label)+"_"+fi
								}))
						})),
					normalizedRelationships:x.normalizedRelationships.map((r,ri)=>Object.assign(r,{
							leftViewName:lookmlName(r.leftViewName),
							rightViewName:lookmlName(r.rightViewName),
						}))
				});
		}
	// "Custom functions" for use in this template. Pure funtions go here, fn's w/closures go in the template...
	function lookmlName(s){
			//return s.slice(0,32).replace(/[\s_]+/g,"_").replace(/[^a-zA-Z0-9_]+/g,"").toLowerCase()
			return s.replace(/[\s]+/g,"_").replace(/[^a-zA-Z0-9_]+/g,"").toLowerCase()
		}
	function measurePaths(view){
			return (["sum","avg","min","max","list"]
					.map(measureType=>view.fields.map(field=>field[measureType] && measureType+"_"+lookmlName(field.label)))
					.reduce(flatten,["count_pk"])
					.filter(truthy)
					.map(field=>view.mName+"."+field)
				)
		};
	function dimensionPaths(view){
			/*TODO Add dimnesion groups
			["dim,dg"]
			.map(dim=>view.fields.map(f=>f[dim] && dim+"_"+lookmlName(f.label)))
			*/
			return (
					view.fields.map(field=>field["dim"] && lookmlName(field.label))
					.reduce(flatten,["pk"])
					.filter(truthy)
					.map(field=>view.dName+"."+field)
				)
		};
	
</script>
<script type="text/x-dot-template" data-name="main">
	<<!
	function parentViewNames() {}
	function ancestorViews(targetView){
			var targetViewName=typeof targetView == "string" ? targetView : targetView.name;
			return recurAncestorNames(targetViewName,6).filter(unique).map(name=>x.views.find(v=>v.name=name));
		
			function recurAncestorNames(targetViewName,remainingRecursion){
					var parentViewNames
							=x.normalizedRelationships
							.filter(rel=>rel.rightView==targetViewName)
							.map(rel=>rel.leftViewName);
					return (parentViewNames.length && remainingRecursion
							? parentViewNames.map(p=>recurAncestorNames(p,remainingRecursion-1)).reduce(flatten,parentViewNames)
							: []
						);
				}
			
		};
	>>
	
	connection: "<<:x.connectionName>>"
	explore: <<:lookmlName(x.exploreName)>> {
		hidden: yes

		# "Measure" joins
		<<* x.views :view:v >>
		join: <<view.mName>> {
			type: full_outer
			view_label: "<<:view.label>>"
			relationship: one_to_one
			<<? x.dialect=="BigQuery Standard" >>
			sql_on: FALSE ;;
			<<?? x.dialect=="Redshift" >>
			#Redshift (Only allows FOJ on merge joins, which require dist & sort key equality)
			sql_on: 
					<<:view.mName>>.<<:view.rs.dist>> = <<:x.exploreName>>.base
				AND <<:view.mName>>.<<:view.rs.sort>> = <<:x.exploreName>>.base 
				<<* x.views.filter((prior,p)=>p<v) :prior:p >>
				{% if <<:
					measurePaths(view)
					.map(m=>m+"._in_query")
					.join("\n\t\t\t\t or ")
				>> %}
				AND <<:view.mName>>.<<:view.rs.dist>> = <<:prior.mName>>.<<:prior.rs.dist>>
				AND <<:view.mName>>.<<:view.rs.sort>> = <<:prior.mName>>.<<:prior.rs.sort>>
				{% endif %}
				<<*>>
				;;
	 		<<?>>
		}
		<<*>>

		#"Dimension table" joins
		<<* x.views :view >>
		join: <<:view.dName>> {
			type: left_outer
			relationship: many_to_one
			required_joins:[
				<<:view.mName>>
				<<* ancestorViews(view) :aView>>
				,<<:aView.mName>>
				,<<:aView.dName>>
				<<*>>
			]
			sql_table_name: {%
				if <<*
				measurePaths(view)
				.concat(ancestorViews(view).map(aView=>measurePaths(aView)))
				.concat(ancestorViews(view).map(aView=>dimensionPaths(aView)))
				:fieldPath:f
				>><<?f==0>>if<<??>>or<<?>> <<:fieldPath>>._in_query
				<<*>>
				%} <<:view.table>> {%
				else
				%} (SELECT null as <<:view.pk.sql>>
					<<* x.normalizedRelationships :rel>>
						<<? rel.leftViewName==view.name >>
						, null as <<:rel.foreignKey>>
						<<?>>
					<<*>>
					FROM (SELECT NULL x) X WHERE x IS NOT NULL) {%
				endif %}
			;;
			
			sql_on: <<:view.dName>>.<<:view.pk.sql>>=COALESCE(
				<<* x.normalizedRelationships
					.filter(rel=>rel.rightViewName=view.name)
					:rel>>
					<<! let base=x.views.find(v=>v.name==rel.leftViewName); >>
					{%
						<<* dimensionPaths(base) :measure:m >>
						<<?m==0>>if<<??>>or<<?>> <<:measure>>._in_query
						<<*>>
					%}<<:base.dName>>.<<:rel.foreignKey>>,{% endif %}
					{%
						<<* measurePaths(base) :measure:m >>
						<<?m==0>>if<<??>>or<<?>> <<:measure>>._in_query
						<<*>>
					%}<<:base.mName>>.<<:rel.foreignKey>>,{% endif %}
				<<*>>
				<<:view.mName>>.<<:view.pk.sql>>
			);;
		}
		<<*>>
	}

	#"Base" (empty) View
	view: <<:lookmlName(x.exploreName)>> {
		view_label: "[<<:x.exploreName>>]"
		<<? x.dialect=="BigQuery Standard">> #BQ
		sql_table_name: (SELECT base FROM (SELECT null as base) as btable WHERE base IS NOT NULL);;
		<<?? x.dialect=="Redshift">> #Redshift
		derived_table: {
			sql: (SELECT base FROM (SELECT null as base) as btable WHERE base IS NOT NULL) ;;
			persist_for: "120 hours"
			distribution: "base"
			sortkeys: ["base"]
		}
		<<?>>
		dimension: base {
			hidden: yes
			sql: ${TABLE}.base ;;
		}
		<# TODO
		dimension_group: combined {
			type: time
			timeframes: [date,week,month]
			sql: ${combined_date_internal} ;;
		}
		dimension: combined_date_internal {
			hidden: yes
			sql: COALESCE({%
			  if pageviews.count._in_query
			  or all_the_things.product_conversion_rate._in_query
			  %}
			  pageviews.pv_date, {% endif %}{%
			  if orders.count._in_query
			  or orders.total_sales._in_query
			  or all_the_things.product_conversion_rate._in_query
			  %}
			  CASE {% parameter orders.combined_date_on %}
			  WHEN 'Order Date' THEN orders.order_date
			  WHEN 'Shipped Date' THEN orders.shipped_date
			  ELSE orders.order_date
			  END, {% endif %}
			  CAST(NULL as timestamp)
			);;
		}
		measure: product_conversion_rate {
			type: number
			value_format_name: decimal_3
			sql: CASE WHEN ${pageviews.count}<>0 THEN ${orders.count} / ${pageviews.count} ELSE NULL END;;
		}
		#>
	}

	<<* x.views :view >>
	view: <<:view.mName>> { #Measure view
		label: "<<:view.label>>"
		sql_table_name: <<:view.table>>;;
		dimension: pk {
			hidden: yes
			sql: <<:view.pk.sql>>;;
		}
		measure: count_pk {
			hidden: <<:view.pk.count ? "no" : "yes">>
			type: number
			sql: CASE WHEN MIN(${pk}) IS NULL THEN NULL ELSE COUNT(${pk}) END ;;
		}
		<<*view.fields :field>>
		<<?field.sum>> 
		measure: sum_<<:lookmlName(field.label)>> {
			type: number;
			label: "Sum of <<:field.label>>"
			sql: SUM(<<:field.sql>>) ;;
			<<:field.otherLookml>>
		}
		<<?>>
		
		<<?field.avg>> 
		measure: avg_<<:lookmlName(field.label)>> {
			type: number;
			label: "Average of <<:field.label>>"
			sql: AVG(<<:field.sql>>) ;;
			<<:field.otherLookml>>
		}
		<<?>>
		
		<<?field.min>> 
		measure: min_<<:lookmlName(field.label)>> {
			label: "Min of <<:field.label>>"
			sql: MIN(<<:field.sql>>) ;;
			<<:field.otherLookml>>
		}
		<<?>>
		
		<<?field.max>> 
		measure: max_<<:lookmlName(field.label)>> {
			label: "Max of <<:field.label>>"
			sql: MAX(<<:field.sql>>) ;;
			<<:field.otherLookml>>
		}
		<<?>>
		
		<<?field.list>> 
		measure: list_<<:lookmlName(field.label)>> {
			label: "List of <<:field.label>>"
			<<? x.dialect=="Redshift">>sql: LISTAGG(<<:field.sql>>,', ') ;;<<?>>
			<<? x.dialect=="BigQuery Standard">>sql: GROUP_CONCAT(<<:field.sql>>) ;;<<?>>
			<<:field.otherLookml>>
		}
		<<?>>
		<<*>>
	}

	view: <<:view.dName>> { #Dimension view
		label: "<<:view.label>>"
		sql_table_name: <<:view.table>>;;
		dimension: pk {
			hidden: <<:view.pk.dim ? "no" : "yes">>
			label: "<<:view.label>> ID"
			sql: <<:view.pk.sql>>;;
		}
		<<* view.fields :field>>
		<<?field.dim>> 
		measure: dim_<<:lookmlName(field.label)>> {
			label: "<<:field.label>>"
			sql: <<:field.sql>> ;;
			<<:field.otherLookml>>
		}
		<<?>>
		<<?field.dg>> 
		measure: dg_<<:lookmlName(field.label)>> {
			group_label: "<<:field.label>>"
			timeframes: [<<:timeframes.join(",")>>]
			sql: <<:field.sql>> ;;
			<<:field.otherLookml>>
		}
		<<?>>
		<<*>>
	}
	<<*>>
</script>
</html>
